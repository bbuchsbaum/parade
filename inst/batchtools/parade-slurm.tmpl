#!/bin/bash
# Template for batchtools + Slurm
# Job name: <%= job.name %>
#SBATCH --job-name=<%= job.name %>
#SBATCH --output=<%= log.file %>
#SBATCH --error=<%= log.file %>
<% if (!is.null(resources$partition))       { %>#SBATCH --partition=<%= resources$partition %><% } %>
<% if (!is.null(resources$account))         { %>#SBATCH --account=<%= resources$account %><% } %>
<% if (!is.null(resources$qos))             { %>#SBATCH --qos=<%= resources$qos %><% } %>
<% if (!is.null(resources$time))            { %>#SBATCH --time=<%= resources$time %><% } %>
<% if (!is.null(resources$nodes))           { %>#SBATCH --nodes=<%= resources$nodes %><% } %>
<% if (!is.null(resources$ntasks))          { %>#SBATCH --ntasks=<%= resources$ntasks %><% } %>
<% if (!is.null(resources$ntasks_per_node)) { %>#SBATCH --ntasks-per-node=<%= resources$ntasks_per_node %><% } %>
<% if (!is.null(resources$cpus_per_task))   { %>#SBATCH --cpus-per-task=<%= resources$cpus_per_task %><% } %>
<% if (!is.null(resources$mem))             { %>#SBATCH --mem=<%= resources$mem %><% } %>

set -euo pipefail

## Module handling (auto-detected from submitting session by default):
##   modules = c("StdEnv/2023", "r/4.4.0")  -> purge + load each
##   modules = character(0)                  -> no module manipulation
<% if (length(resources$modules) > 0) { %>
module purge || true
<% for (mod in resources$modules) { %>
module load <%= mod %>
<% } %>
<% } %>

export PARADE_SCRATCH=${SLURM_TMPDIR:-${TMPDIR:-/tmp}}/parade-$SLURM_JOB_ID
export OMP_NUM_THREADS=${OMP_NUM_THREADS:-1}
export MKL_NUM_THREADS=${MKL_NUM_THREADS:-$OMP_NUM_THREADS}
export OPENBLAS_NUM_THREADS=${OPENBLAS_NUM_THREADS:-$OMP_NUM_THREADS}

Rscript -e 'batchtools::doJobCollection("<%= uri %>")'
