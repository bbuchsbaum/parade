<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Artifacts: format-agnostic sinks, atomic writes, and manifests</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Artifacts: format-agnostic sinks, atomic
writes, and manifests</h1>



<blockquote>
<p>Requires <strong>parade ‚â• 0.12.0</strong> for format-agnostic sinks
(‚â• 0.6.0 for basic sinks).</p>
</blockquote>
<div id="what-are-sinks-and-artifacts" class="section level2">
<h2>What are sinks and artifacts?</h2>
<p><strong>Sinks</strong> in parade provide a powerful mechanism for
persisting large computational results to disk instead of keeping them
in memory. When your stages produce big objects (models, large datasets,
complex results), sinks automatically write these to files and return
lightweight <strong>file references</strong> instead.</p>
<div id="key-benefits" class="section level3">
<h3>Key benefits</h3>
<ul>
<li><strong>Memory efficiency</strong>: Large objects don‚Äôt accumulate
in memory across pipeline stages</li>
<li><strong>Format flexibility</strong>: Support for RDS, CSV, JSON,
Parquet, and custom formats</li>
<li><strong>Persistence</strong>: Results survive R session crashes and
can be accessed later</li>
<li><strong>Atomic writes</strong>: Files are written safely without
corruption risks</li>
<li><strong>Metadata tracking</strong>: Optional JSON sidecars with
checksums (sha256) and byte sizes</li>
<li><strong>Flexible organization</strong>: Configurable directory
structures and file naming</li>
</ul>
</div>
<div id="sinks-vs.-regular-return-values" class="section level3">
<h3>Sinks vs.¬†regular return values</h3>
<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Regular returns</strong></th>
<th><strong>Sink artifacts</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Objects stay in memory</td>
<td>Objects written to disk</td>
</tr>
<tr class="even">
<td>Passed directly between stages</td>
<td>File references passed instead</td>
</tr>
<tr class="odd">
<td>Lost when R session ends</td>
<td>Persist across sessions</td>
</tr>
<tr class="even">
<td>Can cause memory issues with large data</td>
<td>Memory-efficient regardless of size</td>
</tr>
<tr class="odd">
<td>No automatic metadata</td>
<td>Rich metadata (size, checksum, timestamps)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="quick-start-sink_quick-for-rapid-prototyping" class="section level2">
<h2>Quick start: sink_quick() for rapid prototyping</h2>
<p>New in parade 0.12.0, <code>sink_quick()</code> provides the fastest
way to create sinks:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># One-liner sink using registered format</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>sink <span class="ot">&lt;-</span> <span class="fu">sink_quick</span>(<span class="st">&quot;result&quot;</span>, <span class="at">write =</span> <span class="st">&quot;rds&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co"># CSV sink with formula syntax</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>csv_sink <span class="ot">&lt;-</span> <span class="fu">sink_quick</span>(<span class="st">&quot;data&quot;</span>,</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="at">write =</span> <span class="sc">~</span> <span class="fu">write.csv</span>(.x, .path, <span class="at">row.names =</span> <span class="cn">FALSE</span>),</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  <span class="at">read =</span> <span class="sc">~</span> <span class="fu">read.csv</span>(.path, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>),</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>  <span class="at">ext =</span> <span class="st">&quot;.csv&quot;</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>)</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co"># Temporary sink for testing (writes to tempdir)</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>tmp_sink <span class="ot">&lt;-</span> <span class="fu">sink_temp</span>(<span class="st">&quot;output&quot;</span>, <span class="at">write =</span> <span class="st">&quot;json&quot;</span>)</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="co"># Use in a flow</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">flow</span>(grid) <span class="sc">|&gt;</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  <span class="fu">stage</span>(<span class="st">&quot;process&quot;</span>,</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>    <span class="at">f =</span> <span class="cf">function</span>(x) <span class="fu">list</span>(<span class="at">result =</span> <span class="fu">process_data</span>(x)),</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>    <span class="at">schema =</span> <span class="fu">returns</span>(<span class="at">result =</span> <span class="fu">artifact</span>()),</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>    <span class="at">sink =</span> <span class="fu">sink_quick</span>(<span class="st">&quot;result&quot;</span>, <span class="at">write =</span> <span class="st">&quot;parquet&quot;</span>)</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>  )</span></code></pre></div>
<div id="formula-syntax-conventions" class="section level3">
<h3>Formula syntax conventions</h3>
<p>When using formulas with <code>sink_quick()</code>, three special
variables are available: - <code>.x</code> - the object to write (the
data being saved) - <code>.path</code> - the full target path (includes
file extension, e.g., ‚Äúdata/output.csv‚Äù) - <code>.base</code> - the
target path without extension (e.g., ‚Äúdata/output‚Äù)</p>
<p>Example:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Custom write function using formula variables</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">sink_quick</span>(<span class="st">&quot;output&quot;</span>,</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  <span class="at">write =</span> <span class="sc">~</span> {</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;Writing &quot;</span>, <span class="fu">class</span>(.x)[<span class="dv">1</span>], <span class="st">&quot; to &quot;</span>, .path)  <span class="co"># .x is your data object</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(.x) <span class="sc">&gt;</span> <span class="dv">1000</span>) {</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>      <span class="co"># For large data, write to multiple files</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>      <span class="fu">write.csv</span>(.x[<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,], <span class="fu">paste0</span>(.base, <span class="st">&quot;_part1.csv&quot;</span>))     <span class="co"># .base for custom names</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>      <span class="fu">write.csv</span>(.x[<span class="dv">1001</span><span class="sc">:</span><span class="fu">nrow</span>(.x),], <span class="fu">paste0</span>(.base, <span class="st">&quot;_part2.csv&quot;</span>))</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>      <span class="fu">write.csv</span>(.x, .path, <span class="at">row.names =</span> <span class="cn">FALSE</span>)                 <span class="co"># .path for standard output</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>    }</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>  },</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>  <span class="at">ext =</span> <span class="st">&quot;.csv&quot;</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
<div id="format-agnostic-sinks-beyond-rds" class="section level2">
<h2>Format-agnostic sinks: beyond RDS</h2>
<p>Parade now supports <strong>any file format</strong> through a
flexible registry system. Choose the optimal format for your use
case:</p>
<div id="built-in-formats" class="section level3">
<h3>Built-in formats</h3>
<table>
<colgroup>
<col width="12%" />
<col width="11%" />
<col width="9%" />
<col width="22%" />
<col width="28%" />
<col width="15%" />
</colgroup>
<thead>
<tr class="header">
<th>Format</th>
<th>Speed</th>
<th>Size</th>
<th>Type Support</th>
<th>Package Required</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>rds</strong></td>
<td>Fast</td>
<td>Medium</td>
<td>All R objects</td>
<td>None</td>
<td>Default, R-only workflows</td>
</tr>
<tr class="even">
<td><strong>qs</strong></td>
<td>Fastest</td>
<td>Smallest</td>
<td>All R objects</td>
<td>qs</td>
<td>High-performance R</td>
</tr>
<tr class="odd">
<td><strong>parquet</strong></td>
<td>Fast</td>
<td>Small</td>
<td>Data frames</td>
<td>arrow</td>
<td>Cross-language, columnar</td>
</tr>
<tr class="even">
<td><strong>feather</strong></td>
<td>Very fast</td>
<td>Medium</td>
<td>Data frames</td>
<td>arrow</td>
<td>Fast interchange</td>
</tr>
<tr class="odd">
<td><strong>csv</strong></td>
<td>Slow</td>
<td>Large</td>
<td>Data frames</td>
<td>None</td>
<td>Universal compatibility</td>
</tr>
<tr class="even">
<td><strong>json</strong></td>
<td>Medium</td>
<td>Large</td>
<td>Lists/vectors</td>
<td>jsonlite</td>
<td>Config, web APIs</td>
</tr>
</tbody>
</table>
</div>
<div id="check-available-formats" class="section level3">
<h3>Check available formats</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># List all registered formats</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">list_sink_formats</span>()</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co"># [1] &quot;csv&quot; &quot;feather&quot; &quot;json&quot; &quot;parquet&quot; &quot;qs&quot; &quot;rds&quot; &quot;readr_csv&quot; &quot;tsv&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co"># Check if a specific format is available</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="fu">has_sink_format</span>(<span class="st">&quot;parquet&quot;</span>)  <span class="co"># TRUE if arrow is installed</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co"># Get format details</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>fmt <span class="ot">&lt;-</span> <span class="fu">get_sink_format</span>(<span class="st">&quot;parquet&quot;</span>)</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co"># List with writer, reader, ext, atomic fields</span></span></code></pre></div>
</div>
</div>
<div id="define-a-sink-with-sink_spec" class="section level2">
<h2>1) Define a sink with sink_spec()</h2>
<p>The traditional <code>sink_spec()</code> function now supports
multiple formats:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Single format for all fields</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>sink <span class="ot">&lt;-</span> <span class="fu">sink_spec</span>(</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="at">fields   =</span> <span class="fu">c</span>(<span class="st">&quot;model&quot;</span>, <span class="st">&quot;metrics&quot;</span>),      <span class="co"># Which fields to persist</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="at">dir      =</span> <span class="st">&quot;artifacts://fits&quot;</span>,         <span class="co"># Base directory</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  <span class="at">format   =</span> <span class="st">&quot;parquet&quot;</span>,                   <span class="co"># Use Parquet format</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  <span class="at">template =</span> <span class="st">&quot;{.stage}/{subject}/{session}-{.row_key}&quot;</span>,</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="st">&quot;skip&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>)</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co"># Different format per field (new!)</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>multi_sink <span class="ot">&lt;-</span> <span class="fu">sink_spec</span>(</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>  <span class="at">fields =</span> <span class="fu">c</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;model&quot;</span>, <span class="st">&quot;config&quot;</span>),</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;artifacts://mixed&quot;</span>,</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>  <span class="at">formats =</span> <span class="fu">list</span>(</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>    <span class="at">data =</span> <span class="st">&quot;parquet&quot;</span>,    <span class="co"># Fast columnar format for data</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">&quot;qs&quot;</span>,        <span class="co"># Ultra-fast R serialization for models</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>    <span class="at">config =</span> <span class="st">&quot;json&quot;</span>      <span class="co"># Human-readable for configuration</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>  )</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>)</span></code></pre></div>
<div id="key-parameters-explained" class="section level3">
<h3>Key parameters explained</h3>
<ul>
<li><strong><code>fields</code></strong>: Character vector of output
field names to persist</li>
<li><strong><code>dir</code></strong>: Base directory path (can use
aliases like <code>artifacts://</code>)</li>
<li><strong><code>format</code></strong>: Single format name or custom
writer function</li>
<li><strong><code>formats</code></strong>: Named list for per-field
format specifications (new!)</li>
<li><strong><code>template</code></strong>: Glue template for file paths
with variables:
<ul>
<li><code>{.stage}</code>: Current stage name</li>
<li><code>{.field}</code>: Field being written</li>
<li><code>{.row_key}</code>: Unique hash of row parameters</li>
<li>Plus any columns from your parameter grid</li>
</ul></li>
<li><strong><code>overwrite</code></strong>: ‚Äúskip‚Äù (default),
‚Äúoverwrite‚Äù, or ‚Äúerror‚Äù</li>
<li><strong><code>sidecar</code></strong>: JSON metadata with checksums
and timestamps</li>
</ul>
</div>
</div>
<div id="register-custom-formats" class="section level2">
<h2>2) Register custom formats</h2>
<p>Extend parade with your own formats using the registry system:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Register a custom format globally</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="fu">register_sink_format</span>(<span class="st">&quot;nifti&quot;</span>,</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="at">writer =</span> <span class="cf">function</span>(x, path, ...) {</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    neuroim2<span class="sc">::</span><span class="fu">write_vol</span>(x, path)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    <span class="fu">invisible</span>(path)</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  },</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  <span class="at">reader =</span> <span class="cf">function</span>(path, ...) {</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>    neuroim2<span class="sc">::</span><span class="fu">read_vol</span>(path)</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>  },</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>  <span class="at">ext =</span> <span class="st">&quot;.nii.gz&quot;</span>,</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>  <span class="at">atomic =</span> <span class="cn">TRUE</span>  <span class="co"># Use temp-then-rename pattern</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>)</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="co"># Now use it anywhere</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>brain_sink <span class="ot">&lt;-</span> <span class="fu">sink_quick</span>(<span class="st">&quot;brain_data&quot;</span>, <span class="at">write =</span> <span class="st">&quot;nifti&quot;</span>)</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a><span class="co"># Or define inline without registration</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>custom_sink <span class="ot">&lt;-</span> <span class="fu">sink_quick</span>(<span class="st">&quot;special&quot;</span>,</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>  <span class="at">write =</span> <span class="cf">function</span>(x, path) {</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>    <span class="co"># Your custom write logic</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>    <span class="fu">my_special_writer</span>(x, path)</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>  },</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>  <span class="at">read =</span> <span class="cf">function</span>(path) {</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>    <span class="fu">my_special_reader</span>(path)</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>  },</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>  <span class="at">ext =</span> <span class="st">&quot;.custom&quot;</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>)</span></code></pre></div>
<div id="example-hdf5-format-for-scientific-data" class="section level3">
<h3>Example: HDF5 format for scientific data</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Register HDF5 support</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">&quot;hdf5r&quot;</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="fu">register_sink_format</span>(<span class="st">&quot;hdf5&quot;</span>,</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    <span class="at">writer =</span> <span class="cf">function</span>(x, path, ...) {</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>      file <span class="ot">&lt;-</span> hdf5r<span class="sc">::</span>H5File<span class="sc">$</span><span class="fu">new</span>(path, <span class="at">mode =</span> <span class="st">&quot;w&quot;</span>)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>      <span class="fu">tryCatch</span>({</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>        file[[<span class="st">&quot;data&quot;</span>]] <span class="ot">&lt;-</span> x</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>        <span class="fu">invisible</span>(path)</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;Failed to write HDF5 file: &quot;</span>, e<span class="sc">$</span>message)</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>      }, <span class="at">finally =</span> {</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>        <span class="co"># Ensure file is closed even if write fails</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>        <span class="cf">if</span> (file<span class="sc">$</span>is_valid) file<span class="sc">$</span><span class="fu">close</span>()</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>      })</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>    },</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    <span class="at">reader =</span> <span class="cf">function</span>(path, ...) {</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>      file <span class="ot">&lt;-</span> hdf5r<span class="sc">::</span>H5File<span class="sc">$</span><span class="fu">new</span>(path, <span class="at">mode =</span> <span class="st">&quot;r&quot;</span>)</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>      <span class="fu">tryCatch</span>({</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>        data <span class="ot">&lt;-</span> file[[<span class="st">&quot;data&quot;</span>]][]</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>        data</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;Failed to read HDF5 file: &quot;</span>, e<span class="sc">$</span>message)</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>      }, <span class="at">finally =</span> {</span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>        <span class="co"># Ensure file is closed even if read fails</span></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>        <span class="cf">if</span> (file<span class="sc">$</span>is_valid) file<span class="sc">$</span><span class="fu">close</span>()</span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>      })</span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>    },</span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>    <span class="at">ext =</span> <span class="st">&quot;.h5&quot;</span></span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>  )</span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="temporary-sinks-for-development" class="section level2">
<h2>3) Temporary sinks for development</h2>
<p>Use <code>sink_temp()</code> for ephemeral storage during development
and testing:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Creates sink in tempdir() with timestamp</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>dev_sink <span class="ot">&lt;-</span> <span class="fu">sink_temp</span>(<span class="st">&quot;test_output&quot;</span>, <span class="at">write =</span> <span class="st">&quot;json&quot;</span>)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co"># Custom prefix for organization</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>test_sink <span class="ot">&lt;-</span> <span class="fu">sink_temp</span>(<span class="st">&quot;experiment&quot;</span>,</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="at">write =</span> <span class="st">&quot;csv&quot;</span>,</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="at">prefix =</span> <span class="st">&quot;unittest&quot;</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="co"># Perfect for iterative development</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">flow</span>(small_test_data) <span class="sc">|&gt;</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>  <span class="fu">stage</span>(<span class="st">&quot;test&quot;</span>,</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>    <span class="at">f =</span> my_experimental_function,</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>    <span class="at">schema =</span> <span class="fu">returns</span>(<span class="at">output =</span> <span class="fu">artifact</span>()),</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>    <span class="at">sink =</span> <span class="fu">sink_temp</span>(<span class="st">&quot;output&quot;</span>, <span class="at">write =</span> <span class="st">&quot;rds&quot;</span>)  <span class="co"># No cleanup needed!</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>  )</span></code></pre></div>
<p>Files are written to <code>tempdir()/parade-quick-TIMESTAMP/</code>.
Temporary directories are often cleaned by the OS between sessions, but
this is not guaranteed; use <code>unlink(path, recursive = TRUE)</code>
if you need explicit cleanup.</p>
</div>
<div id="using-sinks-in-stages" class="section level2">
<h2>4) Using sinks in stages</h2>
<p>Attach sinks to stages and declare outputs as artifacts:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># Create parameter grid</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">param_grid</span>(</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="at">subject =</span> <span class="fu">c</span>(<span class="st">&quot;s01&quot;</span>, <span class="st">&quot;s02&quot;</span>, <span class="st">&quot;s03&quot;</span>),</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>  <span class="at">session =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>  <span class="at">condition =</span> <span class="fu">c</span>(<span class="st">&quot;control&quot;</span>, <span class="st">&quot;treatment&quot;</span>)</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>)</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="co"># Multi-format workflow</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">flow</span>(grid, <span class="at">seed_col =</span> <span class="st">&quot;seed&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>  <span class="fu">stage</span>(<span class="st">&quot;process&quot;</span>,</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>    <span class="at">f =</span> <span class="cf">function</span>(subject, session, condition) {</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>      <span class="co"># Different outputs need different formats</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>      raw_data <span class="ot">&lt;-</span> <span class="fu">simulate_measurements</span>(<span class="at">n =</span> <span class="dv">10000</span>)  <span class="co"># Large numeric matrix</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>      summary_stats <span class="ot">&lt;-</span> <span class="fu">summarize_data</span>(raw_data)     <span class="co"># Small data frame</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>      metadata <span class="ot">&lt;-</span> <span class="fu">list</span>(                             <span class="co"># Nested list</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>        <span class="at">subject =</span> subject,</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>        <span class="at">session =</span> session,</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>        <span class="at">condition =</span> condition,</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>        <span class="at">timestamp =</span> <span class="fu">Sys.time</span>(),</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>        <span class="at">parameters =</span> <span class="fu">get_analysis_params</span>()</span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>      )</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>      </span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>        <span class="at">raw_data =</span> raw_data,</span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a>        <span class="at">summary =</span> summary_stats,</span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a>        <span class="at">metadata =</span> metadata</span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a>      )</span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a>    },</span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a>    <span class="at">schema =</span> <span class="fu">schema</span>(</span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a>      <span class="at">raw_data =</span> <span class="fu">artifact</span>(),</span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a>      <span class="at">summary =</span> <span class="fu">artifact</span>(),</span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a>      <span class="at">metadata =</span> <span class="fu">artifact</span>()</span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a>    ),</span>
<span id="cb8-34"><a href="#cb8-34" tabindex="-1"></a>    <span class="at">sink =</span> <span class="fu">sink_spec</span>(</span>
<span id="cb8-35"><a href="#cb8-35" tabindex="-1"></a>      <span class="at">fields =</span> <span class="fu">c</span>(<span class="st">&quot;raw_data&quot;</span>, <span class="st">&quot;summary&quot;</span>, <span class="st">&quot;metadata&quot;</span>),</span>
<span id="cb8-36"><a href="#cb8-36" tabindex="-1"></a>      <span class="at">dir =</span> <span class="st">&quot;artifacts://analysis&quot;</span>,</span>
<span id="cb8-37"><a href="#cb8-37" tabindex="-1"></a>      <span class="at">formats =</span> <span class="fu">list</span>(</span>
<span id="cb8-38"><a href="#cb8-38" tabindex="-1"></a>        <span class="at">raw_data =</span> <span class="st">&quot;qs&quot;</span>,      <span class="co"># Fast for large matrices</span></span>
<span id="cb8-39"><a href="#cb8-39" tabindex="-1"></a>        <span class="at">summary =</span> <span class="st">&quot;csv&quot;</span>,      <span class="co"># Readable, shareable</span></span>
<span id="cb8-40"><a href="#cb8-40" tabindex="-1"></a>        <span class="at">metadata =</span> <span class="st">&quot;json&quot;</span>     <span class="co"># Human-readable config</span></span>
<span id="cb8-41"><a href="#cb8-41" tabindex="-1"></a>      )</span>
<span id="cb8-42"><a href="#cb8-42" tabindex="-1"></a>    )</span>
<span id="cb8-43"><a href="#cb8-43" tabindex="-1"></a>  )</span>
<span id="cb8-44"><a href="#cb8-44" tabindex="-1"></a></span>
<span id="cb8-45"><a href="#cb8-45" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">collect</span>(fl)</span></code></pre></div>
</div>
<div id="reading-artifacts-back" class="section level2">
<h2>5) Reading artifacts back</h2>
<div id="automatic-loading-in-downstream-stages" class="section level3">
<h3>Automatic loading in downstream stages</h3>
<p>With <code>autoload = TRUE</code> (default), artifacts load
automatically:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>fl <span class="ot">&lt;-</span> fl <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  <span class="fu">stage</span>(<span class="st">&quot;analyze&quot;</span>,</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>    <span class="at">f =</span> <span class="cf">function</span>(raw_data, summary, metadata) {</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>      <span class="co"># All three artifacts are loaded automatically</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>      <span class="co"># in their appropriate formats</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>      combined <span class="ot">&lt;-</span> <span class="fu">merge_with_metadata</span>(raw_data, metadata)</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>      enhanced <span class="ot">&lt;-</span> <span class="fu">enhance_summary</span>(summary, combined)</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">final =</span> enhanced)</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>    },</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>    <span class="at">schema =</span> <span class="fu">returns</span>(<span class="at">final =</span> <span class="fu">tbl</span>())</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="manual-loading" class="section level3">
<h3>Manual loading</h3>
<p>Access artifacts directly using file references:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">collect</span>(fl)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co"># Each artifact field contains file metadata</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>results<span class="sc">$</span>raw_data[[<span class="dv">1</span>]]</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co"># tibble: path, bytes, sha256, written, existed</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co"># Load manually using the path</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(results<span class="sc">$</span>raw_data[[<span class="dv">1</span>]]<span class="sc">$</span>path)  <span class="co"># For RDS</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(results<span class="sc">$</span>summary[[<span class="dv">1</span>]]<span class="sc">$</span>path)  <span class="co"># For CSV</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>data <span class="ot">&lt;-</span> jsonlite<span class="sc">::</span><span class="fu">read_json</span>(results<span class="sc">$</span>metadata[[<span class="dv">1</span>]]<span class="sc">$</span>path)  <span class="co"># For JSON</span></span></code></pre></div>
</div>
<div id="using-the-manifest-system" class="section level3">
<h3>Using the manifest system</h3>
<p>Query and explore all artifacts:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># Find all Parquet files</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="fu">manifest</span>(<span class="st">&quot;artifacts://&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.parquet$&quot;</span>, path)) <span class="sc">|&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(mtime))</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co"># Load recent large files</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>recent_large <span class="ot">&lt;-</span> <span class="fu">manifest</span>(<span class="st">&quot;artifacts://analysis&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>    mtime <span class="sc">&gt;</span> <span class="fu">Sys.time</span>() <span class="sc">-</span> <span class="dv">86400</span>,  <span class="co"># Last 24 hours</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>    bytes <span class="sc">&gt;</span> <span class="fl">1e6</span>                   <span class="co"># Larger than 1MB</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>    <span class="at">format =</span> tools<span class="sc">::</span><span class="fu">file_ext</span>(path),</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map</span>(path, <span class="sc">~</span> {</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.qs$&quot;</span>, .x)) qs<span class="sc">::</span><span class="fu">qread</span>(.x)</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.parquet$&quot;</span>, .x)) arrow<span class="sc">::</span><span class="fu">read_parquet</span>(.x)</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>      <span class="cf">else</span> <span class="fu">readRDS</span>(.x)</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>    })</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>  )</span></code></pre></div>
</div>
</div>
<div id="format-selection-guide" class="section level2">
<h2>Format selection guide</h2>
<div id="when-to-use-each-format" class="section level3">
<h3>When to use each format</h3>
<p><strong>RDS (default)</strong> - ‚úÖ Any R object (models, lists,
environments) - ‚úÖ Preserves all R attributes and classes - ‚ùå R-only,
not readable by other languages - üìä Best for: R-specific workflows,
complex objects</p>
<p><strong>QS (when available)</strong> - ‚úÖ 3-5x faster than RDS - ‚úÖ
30-50% smaller files - ‚úÖ Supports all R objects - ‚ùå Requires qs
package - üìä Best for: High-performance R workflows</p>
<p><strong>Parquet</strong> - ‚úÖ Columnar format, excellent compression
- ‚úÖ Cross-language (Python, Julia, etc.) - ‚úÖ Fast for data frames - ‚ùå
Data frames only - üìä Best for: Data science pipelines, cross-language
work</p>
<p><strong>CSV</strong> - ‚úÖ Universal compatibility - ‚úÖ Human-readable
- ‚ùå Slow, large files - ‚ùå Type information lost - üìä Best for: Sharing
results, small data</p>
<p><strong>JSON</strong> - ‚úÖ Human-readable - ‚úÖ Good for nested
structures - ‚úÖ Web API compatible - ‚ùå Larger files - üìä Best for:
Configuration, metadata, web integration</p>
</div>
</div>
<div id="advanced-examples" class="section level2">
<h2>Advanced examples</h2>
<div id="mixed-format-machine-learning-pipeline" class="section level3">
<h3>Mixed-format machine learning pipeline</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>ml_sink <span class="ot">&lt;-</span> <span class="fu">sink_spec</span>(</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>  <span class="at">fields =</span> <span class="fu">c</span>(<span class="st">&quot;train_data&quot;</span>, <span class="st">&quot;test_data&quot;</span>, <span class="st">&quot;model&quot;</span>, <span class="st">&quot;predictions&quot;</span>, <span class="st">&quot;metrics&quot;</span>),</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;artifacts://ml_pipeline&quot;</span>,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>  <span class="at">formats =</span> <span class="fu">list</span>(</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>    <span class="at">train_data =</span> <span class="st">&quot;parquet&quot;</span>,   <span class="co"># Large, need column access</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>    <span class="at">test_data =</span> <span class="st">&quot;parquet&quot;</span>,    <span class="co"># Consistent with training</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">&quot;qs&quot;</span>,            <span class="co"># Complex R object, need speed</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>    <span class="at">predictions =</span> <span class="st">&quot;csv&quot;</span>,      <span class="co"># Share with stakeholders</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="st">&quot;json&quot;</span>         <span class="co"># Track in version control</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  ),</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  <span class="at">template =</span> <span class="st">&quot;{.stage}/{experiment_id}/{.field}_{fold_id}&quot;</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="scientific-computing-with-custom-formats" class="section level3">
<h3>Scientific computing with custom formats</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Register specialized formats</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="fu">register_sink_format</span>(<span class="st">&quot;matlab&quot;</span>,</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="at">writer =</span> <span class="sc">~</span> R.matlab<span class="sc">::</span><span class="fu">writeMat</span>(.x, .path),</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="at">reader =</span> <span class="sc">~</span> R.matlab<span class="sc">::</span><span class="fu">readMat</span>(.path),</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>  <span class="at">ext =</span> <span class="st">&quot;.mat&quot;</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>)</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="fu">register_sink_format</span>(<span class="st">&quot;netcdf&quot;</span>,</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  <span class="at">writer =</span> <span class="cf">function</span>(x, path) {</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>    ncdf4<span class="sc">::</span><span class="fu">nc_create</span>(path, x<span class="sc">$</span>var_defs)</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>    <span class="co"># ... write logic</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>  },</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>  <span class="at">reader =</span> <span class="sc">~</span> ncdf4<span class="sc">::</span><span class="fu">nc_open</span>(.path),</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>  <span class="at">ext =</span> <span class="st">&quot;.nc&quot;</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>)</span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>scientific_sink <span class="ot">&lt;-</span> <span class="fu">sink_quick</span>(</span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>  <span class="at">fields =</span> <span class="fu">c</span>(<span class="st">&quot;simulation&quot;</span>, <span class="st">&quot;observations&quot;</span>),</span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>  <span class="at">write =</span> <span class="st">&quot;netcdf&quot;</span>,</span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;artifacts://climate_model&quot;</span></span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="quick-iteration-during-development" class="section level3">
<h3>Quick iteration during development</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># Start with temp sink for experimentation</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>dev_flow <span class="ot">&lt;-</span> <span class="fu">flow</span>(test_data) <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>  <span class="fu">stage</span>(<span class="st">&quot;experiment&quot;</span>,</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    <span class="at">f =</span> my_experimental_analysis,</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>    <span class="at">schema =</span> <span class="fu">returns</span>(<span class="at">result =</span> <span class="fu">artifact</span>()),</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    <span class="at">sink =</span> <span class="fu">sink_temp</span>(<span class="st">&quot;result&quot;</span>, <span class="at">write =</span> <span class="st">&quot;rds&quot;</span>)</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  )</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="co"># Test and iterate quickly</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>test_results <span class="ot">&lt;-</span> <span class="fu">collect</span>(dev_flow)</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="co"># When ready, switch to production sink</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>prod_flow <span class="ot">&lt;-</span> <span class="fu">flow</span>(full_data) <span class="sc">|&gt;</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>  <span class="fu">stage</span>(<span class="st">&quot;experiment&quot;</span>,</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>    <span class="at">f =</span> my_experimental_analysis,</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>    <span class="at">schema =</span> <span class="fu">returns</span>(<span class="at">result =</span> <span class="fu">artifact</span>()),</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>    <span class="at">sink =</span> <span class="fu">sink_spec</span>(</span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>      <span class="st">&quot;result&quot;</span>,</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>      <span class="at">dir =</span> <span class="st">&quot;artifacts://production&quot;</span>,</span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>      <span class="at">format =</span> <span class="st">&quot;parquet&quot;</span>  <span class="co"># Better for production</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>    )</span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>  )</span></code></pre></div>
</div>
</div>
<div id="working-with-complex-objects" class="section level2">
<h2>Working with Complex Objects</h2>
<p>The <code>lst()</code> type is parade‚Äôs universal container for
complex R objects that don‚Äôt fit into basic types like
<code>dbl()</code>, <code>chr()</code>, or <code>int()</code>. This
includes:</p>
<ul>
<li><strong>S3 objects</strong>: lm models, custom classes, neuroimaging
objects</li>
<li><strong>S4 objects</strong>: Bioconductor objects, formal class
structures</li>
<li><strong>Nested structures</strong>: Lists of lists, complex
hierarchies</li>
<li><strong>Domain objects</strong>: Brain volumes, genomic data,
spatial objects</li>
<li><strong>Any R object</strong>: Anything that needs to preserve its
full structure</li>
</ul>
<div id="when-to-use-lst-vs-artifact" class="section level3">
<h3>When to use lst() vs artifact()</h3>
<p>Choose based on size and access patterns:</p>
<table>
<thead>
<tr class="header">
<th>Use <code>lst()</code> (in-memory)</th>
<th>Use <code>artifact()</code> (on-disk)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Small objects (&lt;10MB)</td>
<td>Large objects (&gt;10MB)</td>
</tr>
<tr class="even">
<td>Frequently accessed</td>
<td>Accessed occasionally</td>
</tr>
<tr class="odd">
<td>Complex metadata</td>
<td>Primary data arrays</td>
</tr>
<tr class="even">
<td>Model summaries</td>
<td>Full model objects</td>
</tr>
<tr class="odd">
<td>Headers/parameters</td>
<td>Raw data matrices</td>
</tr>
</tbody>
</table>
</div>
<div id="example-neuroimaging-data-with-lst" class="section level3">
<h3>Example: Neuroimaging data with lst()</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># Complex neuroimaging object stays in memory</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">flow</span>(subjects) <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  <span class="fu">stage</span>(<span class="st">&quot;load_brain&quot;</span>,</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    <span class="at">f =</span> <span class="cf">function</span>(subject_id) {</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>      <span class="co"># Returns complex S4 brain volume object</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>      brain <span class="ot">&lt;-</span> neuroim2<span class="sc">::</span><span class="fu">read_vol</span>(<span class="fu">paste0</span>(subject_id, <span class="st">&quot;.nii.gz&quot;</span>))</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>      </span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>        <span class="at">brain =</span> brain,                      <span class="co"># Full S4 object</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>        <span class="at">volume =</span> <span class="fu">sum</span>(brain<span class="sc">@</span>.Data <span class="sc">&gt;</span> <span class="dv">0</span>),     <span class="co"># Scalar summary</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>        <span class="at">dims =</span> brain<span class="sc">@</span>space<span class="sc">@</span>dim              <span class="co"># Vector</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>      )</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    },</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>    <span class="at">schema =</span> <span class="fu">returns</span>(</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>      <span class="at">brain =</span> <span class="fu">lst</span>(),    <span class="co"># Complex object preserved in list column</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>      <span class="at">volume =</span> <span class="fu">dbl</span>(),   <span class="co"># Simple scalar</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>      <span class="at">dims =</span> <span class="fu">int</span>()      <span class="co"># Integer vector</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>    )</span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>  )</span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="co"># The brain object maintains all S4 slots, methods, and attributes</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">collect</span>(fl)</span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a>first_brain <span class="ot">&lt;-</span> results<span class="sc">$</span>brain[[<span class="dv">1</span>]]  <span class="co"># Full brain volume object</span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="fu">class</span>(first_brain)  <span class="co"># &quot;brain_volume&quot; or similar S4 class</span></span></code></pre></div>
</div>
<div id="example-mixed-approach-for-large-data" class="section level3">
<h3>Example: Mixed approach for large data</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co"># Large data as artifact, metadata in memory</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">flow</span>(subjects) <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>  <span class="fu">stage</span>(<span class="st">&quot;process_brain&quot;</span>,</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>    <span class="at">f =</span> <span class="cf">function</span>(subject_id) {</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>      brain <span class="ot">&lt;-</span> <span class="fu">load_and_process_brain</span>(subject_id)</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>      </span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>        <span class="co"># Large 3D/4D array to disk</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>        <span class="at">brain_data =</span> brain<span class="sc">@</span>.Data,</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>        </span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>        <span class="co"># Small metadata in memory</span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>        <span class="at">header =</span> brain<span class="sc">@</span>header,          <span class="co"># S4 object with metadata</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>        <span class="at">space =</span> brain<span class="sc">@</span>space,            <span class="co"># Spatial information</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>        <span class="at">stats =</span> <span class="fu">summarize</span>(brain)        <span class="co"># Summary tibble</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>      )</span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a>    },</span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>    <span class="at">schema =</span> <span class="fu">returns</span>(</span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>      <span class="at">brain_data =</span> <span class="fu">artifact</span>(),  <span class="co"># Large array to disk</span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>      <span class="at">header =</span> <span class="fu">lst</span>(),           <span class="co"># Complex S4 object in memory</span></span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>      <span class="at">space =</span> <span class="fu">lst</span>(),            <span class="co"># Spatial object in memory</span></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>      <span class="at">stats =</span> <span class="fu">tbl</span>()             <span class="co"># Tibble in memory</span></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a>    ),</span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>    <span class="at">sink =</span> <span class="fu">sink_spec</span>(</span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>      <span class="at">fields =</span> <span class="st">&quot;brain_data&quot;</span>,</span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>      <span class="at">dir =</span> <span class="st">&quot;artifacts://neuroimaging&quot;</span>,</span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a>      <span class="at">format =</span> <span class="st">&quot;qs&quot;</span>  <span class="co"># Fast serialization for arrays</span></span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a>    )</span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="key-points-about-lst" class="section level3">
<h3>Key points about lst()</h3>
<ol style="list-style-type: decimal">
<li><strong>Preserves everything</strong>: Class, attributes, methods,
slots - all maintained</li>
<li><strong>No type restrictions</strong>: Any valid R object can go in
<code>lst()</code></li>
<li><strong>List column storage</strong>: Objects are stored in tibble
list columns</li>
<li><strong>Direct access</strong>: No deserialization needed (unlike
artifacts)</li>
<li><strong>Memory considerations</strong>: Keep large data as
artifacts, metadata as <code>lst()</code></li>
</ol>
</div>
</div>
<div id="flexible-type-validation-new-in-0.13.0" class="section level2">
<h2>Flexible Type Validation (New in 0.13.0)</h2>
<p>While <code>lst()</code> accepts any object, you often want to
validate that complex objects have the expected class without requiring
a full prototype. The flexible type system provides lightweight
validation:</p>
<div id="class-based-validation-with-isa" class="section level3">
<h3>Class-based validation with isa()</h3>
<p>Instead of creating prototype objects, use <code>isa()</code> to
validate by class name:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># Traditional approach (requires prototype object)</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="fu">schema</span>(<span class="at">model =</span> <span class="fu">structure</span>(<span class="fu">list</span>(), <span class="at">class =</span> <span class="st">&quot;lm&quot;</span>))  <span class="co"># Awkward!</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="co"># Flexible approach (class name only)</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="fu">schema</span>(<span class="at">model =</span> <span class="fu">isa</span>(<span class="st">&quot;lm&quot;</span>))  <span class="co"># Clean and clear</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="co"># Works with any class, including S4 and package-specific</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="fu">schema</span>(</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>  <span class="at">brain =</span> <span class="fu">isa</span>(<span class="st">&quot;neuroim2::NeuroVol&quot;</span>),</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">isa</span>(<span class="fu">c</span>(<span class="st">&quot;glm&quot;</span>, <span class="st">&quot;lm&quot;</span>)),  <span class="co"># Accepts multiple classes</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>  <span class="at">network =</span> <span class="fu">isa</span>(<span class="st">&quot;igraph&quot;</span>)</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="optional-types-with-maybe" class="section level3">
<h3>Optional types with maybe()</h3>
<p>Allow fields to be NULL or match a specific type:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">flow</span>(grid) <span class="sc">|&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>  <span class="fu">stage</span>(<span class="st">&quot;fit&quot;</span>,</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    <span class="at">f =</span> <span class="cf">function</span>(data) {</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>      model <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">nrow</span>(data) <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="fu">lm</span>(y <span class="sc">~</span> x, data) <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>        <span class="at">model =</span> model,</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>        <span class="at">n_obs =</span> <span class="fu">nrow</span>(data)</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>      )</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>    },</span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>    <span class="at">schema =</span> <span class="fu">returns</span>(</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>      <span class="at">model =</span> <span class="fu">maybe</span>(<span class="fu">isa</span>(<span class="st">&quot;lm&quot;</span>)),  <span class="co"># Can be lm or NULL</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>      <span class="at">n_obs =</span> <span class="fu">int</span>()</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>    )</span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="union-types-with-one_of" class="section level3">
<h3>Union types with one_of()</h3>
<p>Accept multiple possible types:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">schema</span>(</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>  <span class="at">result =</span> <span class="fu">one_of</span>(</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>    <span class="fu">isa</span>(<span class="st">&quot;lm&quot;</span>),      <span class="co"># Linear model</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>    <span class="fu">isa</span>(<span class="st">&quot;glm&quot;</span>),     <span class="co"># Generalized linear model</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>    <span class="fu">isa</span>(<span class="st">&quot;nls&quot;</span>),     <span class="co"># Nonlinear model</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>    <span class="fu">tbl</span>()           <span class="co"># Or a summary table</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>  )</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="predicate-validation-with-pred" class="section level3">
<h3>Predicate validation with pred()</h3>
<p>Custom validation logic with performance hints:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># Light validation (always runs)</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="fu">schema</span>(</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">pred</span>(<span class="sc">~</span> <span class="fu">nrow</span>(.) <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">cost =</span> <span class="st">&quot;light&quot;</span>)</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>)</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="co"># Heavy validation (only in full mode)</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a><span class="fu">schema</span>(</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>  <span class="at">image =</span> <span class="fu">pred</span>(<span class="sc">~</span> <span class="fu">all</span>(<span class="fu">dim</span>(.) <span class="sc">==</span> <span class="fu">c</span>(<span class="dv">91</span>, <span class="dv">109</span>, <span class="dv">91</span>)), <span class="at">cost =</span> <span class="st">&quot;full&quot;</span>)</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>)</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a><span class="co"># Use with collect()</span></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">collect</span>(fl, <span class="at">validate =</span> <span class="st">&quot;light&quot;</span>)  <span class="co"># Skip heavy checks</span></span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>results_validated <span class="ot">&lt;-</span> <span class="fu">collect</span>(fl, <span class="at">validate =</span> <span class="st">&quot;full&quot;</span>)  <span class="co"># Run all checks</span></span></code></pre></div>
</div>
<div id="domain-specific-helpers" class="section level3">
<h3>Domain-specific helpers</h3>
<p>Parade includes neuroimaging-specific validators:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># Any neuroimaging volume</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="fu">schema</span>(<span class="at">brain =</span> <span class="fu">neurovol</span>())</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="co"># Specific volume type</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="fu">schema</span>(<span class="at">mask =</span> <span class="fu">neurovol</span>(<span class="at">class =</span> <span class="st">&quot;LogicalNeuroVol&quot;</span>))</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="co"># With dimension validation (full mode only)</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="fu">schema</span>(<span class="at">mni =</span> <span class="fu">neurovol</span>(<span class="at">dims =</span> <span class="fu">c</span>(<span class="dv">91</span>, <span class="dv">109</span>, <span class="dv">91</span>)))</span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a><span class="co"># Optional neuroimaging data</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a><span class="fu">schema</span>(<span class="at">mask =</span> <span class="fu">maybe_neurovol</span>())</span></code></pre></div>
</div>
<div id="performance-modes" class="section level3">
<h3>Performance modes</h3>
<p>Validation runs in two modes to balance safety and speed:</p>
<table>
<colgroup>
<col width="20%" />
<col width="43%" />
<col width="36%" />
</colgroup>
<thead>
<tr class="header">
<th>Mode</th>
<th>When to use</th>
<th>What runs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>&quot;light&quot;</code> (default)</td>
<td>Normal execution</td>
<td>Class checks, type checks, light predicates</td>
</tr>
<tr class="even">
<td><code>&quot;full&quot;</code></td>
<td>Testing, debugging</td>
<td>All checks including expensive predicates</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># Normal execution - fast</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">collect</span>(flow)  <span class="co"># Default: validate = &quot;light&quot;</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="co"># Thorough validation - slower but comprehensive</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">collect</span>(flow, <span class="at">validate =</span> <span class="st">&quot;full&quot;</span>)</span></code></pre></div>
</div>
<div id="combining-with-traditional-types" class="section level3">
<h3>Combining with traditional types</h3>
<p>Flexible types work seamlessly with parade‚Äôs standard types:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="fu">schema</span>(</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>  <span class="co"># Standard types</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>  <span class="at">id =</span> <span class="fu">chr</span>(),</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>  <span class="at">score =</span> <span class="fu">dbl</span>(),</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>  </span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>  <span class="co"># Flexible types</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">isa</span>(<span class="st">&quot;lm&quot;</span>),</span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>  <span class="at">optimizer =</span> <span class="fu">maybe</span>(<span class="fu">isa</span>(<span class="st">&quot;optim&quot;</span>)),</span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>  </span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>  <span class="co"># Mixed in artifacts</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>  <span class="at">large_matrix =</span> <span class="fu">artifact</span>(),</span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>  <span class="at">metadata =</span> <span class="fu">one_of</span>(<span class="fu">lst</span>(), <span class="fu">tbl</span>())</span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
<div id="managing-multi-file-outputs" class="section level2">
<h2>Managing Multi-File Outputs</h2>
<p>Many analysis pipelines, especially in neuroimaging and
bioinformatics, generate multiple output files. Parade offers three
clean patterns to handle these scenarios without tracking every
file.</p>
<div id="pattern-a-sentinel-file-recommended" class="section level3">
<h3>Pattern A: Sentinel File (Recommended)</h3>
<p>Track a single ‚Äúdone‚Äù marker file while your pipeline writes many
files. Perfect for preprocessing pipelines that generate dozens of
intermediate files.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co"># Sentinel pattern - track one file that signals success</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>sentinel_sink <span class="ot">&lt;-</span> <span class="fu">sink_quick</span>(</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>  <span class="at">fields =</span> <span class="st">&quot;run&quot;</span>,</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;artifacts://neuro&quot;</span>,</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>  <span class="at">template =</span> <span class="st">&quot;{.stage}/{subject}/{session}/{.row_key}&quot;</span>,</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>  <span class="at">write =</span> <span class="sc">~</span> {</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>    <span class="co"># Check if already done (important when overwrite = &quot;skip&quot;)</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">file.exists</span>(.path)) {</span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">&quot;Skipping - already processed: &quot;</span>, .path)</span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>      <span class="fu">return</span>(.path)  <span class="co"># Return sentinel path without re-running</span></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>    }</span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>    </span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>    out_dir <span class="ot">&lt;-</span> .base  <span class="co"># Path without extension (becomes directory)</span></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a>    <span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>    </span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a>    <span class="co"># 1) Run your pipeline that creates many files</span></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>    <span class="co">#    e.g., FSL, FreeSurfer, fMRIPrep, etc.</span></span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a>    <span class="co"># run_preprocessing_pipeline(</span></span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a>    <span class="co">#   input = .x$input_file,</span></span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a>    <span class="co">#   output_dir = out_dir,</span></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a>    <span class="co">#   steps = c(&quot;motion_correct&quot;, &quot;slice_timing&quot;, &quot;normalize&quot;, &quot;smooth&quot;)</span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a>    <span class="co"># )</span></span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a>    </span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a>    <span class="co"># This might create:</span></span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a>    <span class="co"># - motion_parameters.txt</span></span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a>    <span class="co"># - realigned.nii.gz</span></span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a>    <span class="co"># - mean_func.nii.gz</span></span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a>    <span class="co"># - normalized.nii.gz</span></span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a>    <span class="co"># - smoothed.nii.gz</span></span>
<span id="cb24-30"><a href="#cb24-30" tabindex="-1"></a>    <span class="co"># - preprocessing.log</span></span>
<span id="cb24-31"><a href="#cb24-31" tabindex="-1"></a>    <span class="co"># ... and 20+ other files</span></span>
<span id="cb24-32"><a href="#cb24-32" tabindex="-1"></a>    </span>
<span id="cb24-33"><a href="#cb24-33" tabindex="-1"></a>    <span class="co"># For this example, simulate creating files</span></span>
<span id="cb24-34"><a href="#cb24-34" tabindex="-1"></a>    <span class="co"># max_motion &lt;- 0.5  # Would come from actual preprocessing</span></span>
<span id="cb24-35"><a href="#cb24-35" tabindex="-1"></a>    <span class="co"># temporal_snr &lt;- 100  # Would come from actual preprocessing</span></span>
<span id="cb24-36"><a href="#cb24-36" tabindex="-1"></a>    </span>
<span id="cb24-37"><a href="#cb24-37" tabindex="-1"></a>    <span class="co"># 2) Write a single sentinel file as the only tracked artifact</span></span>
<span id="cb24-38"><a href="#cb24-38" tabindex="-1"></a>    done_info <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb24-39"><a href="#cb24-39" tabindex="-1"></a>      <span class="at">ok =</span> <span class="cn">TRUE</span>,</span>
<span id="cb24-40"><a href="#cb24-40" tabindex="-1"></a>      <span class="at">completed =</span> <span class="fu">Sys.time</span>(),</span>
<span id="cb24-41"><a href="#cb24-41" tabindex="-1"></a>      <span class="at">output_dir =</span> out_dir,</span>
<span id="cb24-42"><a href="#cb24-42" tabindex="-1"></a>      <span class="at">subject =</span> .x<span class="sc">$</span>subject,</span>
<span id="cb24-43"><a href="#cb24-43" tabindex="-1"></a>      <span class="at">session =</span> .x<span class="sc">$</span>session,</span>
<span id="cb24-44"><a href="#cb24-44" tabindex="-1"></a>      <span class="at">files_created =</span> <span class="fu">list.files</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-45"><a href="#cb24-45" tabindex="-1"></a>      <span class="co"># Add your actual QC metrics here:</span></span>
<span id="cb24-46"><a href="#cb24-46" tabindex="-1"></a>      <span class="co"># qc_metrics = list(motion = max_motion, tsnr = temporal_snr)</span></span>
<span id="cb24-47"><a href="#cb24-47" tabindex="-1"></a>    )</span>
<span id="cb24-48"><a href="#cb24-48" tabindex="-1"></a>    jsonlite<span class="sc">::</span><span class="fu">write_json</span>(done_info, .path, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-49"><a href="#cb24-49" tabindex="-1"></a>    .path  <span class="co"># Return only the sentinel path</span></span>
<span id="cb24-50"><a href="#cb24-50" tabindex="-1"></a>  },</span>
<span id="cb24-51"><a href="#cb24-51" tabindex="-1"></a>  <span class="at">read =</span> <span class="sc">~</span> jsonlite<span class="sc">::</span><span class="fu">read_json</span>(.path),</span>
<span id="cb24-52"><a href="#cb24-52" tabindex="-1"></a>  <span class="at">ext =</span> <span class="st">&quot;.done.json&quot;</span>,</span>
<span id="cb24-53"><a href="#cb24-53" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="st">&quot;skip&quot;</span>,    <span class="co"># Critical: skip if done file exists (resume-friendly)</span></span>
<span id="cb24-54"><a href="#cb24-54" tabindex="-1"></a>  <span class="at">autoload =</span> <span class="cn">FALSE</span>,       <span class="co"># Downstream typically doesn&#39;t need the sentinel</span></span>
<span id="cb24-55"><a href="#cb24-55" tabindex="-1"></a>  <span class="at">sidecar =</span> <span class="st">&quot;json&quot;</span>       <span class="co"># Still get checksums for the sentinel</span></span>
<span id="cb24-56"><a href="#cb24-56" tabindex="-1"></a>)</span>
<span id="cb24-57"><a href="#cb24-57" tabindex="-1"></a></span>
<span id="cb24-58"><a href="#cb24-58" tabindex="-1"></a><span class="co"># Use in a flow</span></span>
<span id="cb24-59"><a href="#cb24-59" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">flow</span>(<span class="fu">param_grid</span>(<span class="at">subject =</span> <span class="fu">c</span>(<span class="st">&quot;s01&quot;</span>, <span class="st">&quot;s02&quot;</span>), <span class="at">session =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-60"><a href="#cb24-60" tabindex="-1"></a>  <span class="fu">stage</span>(<span class="st">&quot;preprocess&quot;</span>,</span>
<span id="cb24-61"><a href="#cb24-61" tabindex="-1"></a>    <span class="at">f =</span> <span class="cf">function</span>(subject, session, input_file) {</span>
<span id="cb24-62"><a href="#cb24-62" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">run =</span> <span class="fu">list</span>(</span>
<span id="cb24-63"><a href="#cb24-63" tabindex="-1"></a>        <span class="at">subject =</span> subject,</span>
<span id="cb24-64"><a href="#cb24-64" tabindex="-1"></a>        <span class="at">session =</span> session,</span>
<span id="cb24-65"><a href="#cb24-65" tabindex="-1"></a>        <span class="at">input_file =</span> input_file</span>
<span id="cb24-66"><a href="#cb24-66" tabindex="-1"></a>      ))</span>
<span id="cb24-67"><a href="#cb24-67" tabindex="-1"></a>    },</span>
<span id="cb24-68"><a href="#cb24-68" tabindex="-1"></a>    <span class="at">schema =</span> <span class="fu">returns</span>(<span class="at">run =</span> <span class="fu">artifact</span>()),</span>
<span id="cb24-69"><a href="#cb24-69" tabindex="-1"></a>    <span class="at">sink =</span> sentinel_sink</span>
<span id="cb24-70"><a href="#cb24-70" tabindex="-1"></a>  )</span>
<span id="cb24-71"><a href="#cb24-71" tabindex="-1"></a></span>
<span id="cb24-72"><a href="#cb24-72" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">collect</span>(fl)</span>
<span id="cb24-73"><a href="#cb24-73" tabindex="-1"></a><span class="co"># Only the .done.json file is tracked, but all preprocessing outputs exist</span></span></code></pre></div>
<p><strong>Benefits of sentinel pattern</strong>: - <strong>Minimal
metadata</strong>: Only one artifact per row in manifest - <strong>Fast
resume</strong>: <code>overwrite = &quot;skip&quot;</code> skips completed rows -
<strong>Rich validation</strong>: Sentinel can contain QC metrics, file
lists, parameters - <strong>Clean separation</strong>: Parade tracks
success, filesystem has all outputs</p>
</div>
<div id="pattern-b-bundle-directory" class="section level3">
<h3>Pattern B: Bundle Directory</h3>
<p>Track a directory itself as the artifact when downstream stages need
to explore the contents.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>bundle_sink <span class="ot">&lt;-</span> <span class="fu">sink_quick</span>(</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>  <span class="at">fields =</span> <span class="st">&quot;bundle&quot;</span>,</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;artifacts://analysis&quot;</span>,</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>  <span class="at">template =</span> <span class="st">&quot;{.stage}/{subject}/{session}&quot;</span>,</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>  <span class="at">write =</span> <span class="cf">function</span>(x, path) {</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>    <span class="co"># Path is the directory itself</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>    <span class="fu">dir.create</span>(path, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>    </span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>    <span class="co"># Run pipeline that writes into this directory</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a>    <span class="fu">run_analysis</span>(</span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a>      <span class="at">input =</span> x<span class="sc">$</span>data,</span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a>      <span class="at">output_dir =</span> path,</span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a>      <span class="at">config =</span> x<span class="sc">$</span>config</span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>    )</span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a>    </span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a>    <span class="co"># Optionally write a SUCCESS marker</span></span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>    <span class="fu">writeLines</span>(<span class="st">&quot;OK&quot;</span>, <span class="fu">file.path</span>(path, <span class="st">&quot;SUCCESS&quot;</span>))</span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a>    </span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a>    path  <span class="co"># Return the directory as the artifact</span></span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a>  },</span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a>  <span class="at">read =</span> <span class="cf">function</span>(path) {</span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a>    <span class="co"># Custom reader can list files or check success</span></span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a>      <span class="at">files =</span> <span class="fu">list.files</span>(path, <span class="at">recursive =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a>      <span class="at">success =</span> <span class="fu">file.exists</span>(<span class="fu">file.path</span>(path, <span class="st">&quot;SUCCESS&quot;</span>))</span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a>    )</span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a>  },</span>
<span id="cb25-28"><a href="#cb25-28" tabindex="-1"></a>  <span class="at">ext =</span> <span class="st">&quot;&quot;</span>  <span class="co"># No extension for directories</span></span>
<span id="cb25-29"><a href="#cb25-29" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="pattern-c-primary-output" class="section level3">
<h3>Pattern C: Primary Output</h3>
<p>Track only the main output file when there‚Äôs a clear primary
result.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>primary_sink <span class="ot">&lt;-</span> <span class="fu">sink_quick</span>(</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>  <span class="at">fields =</span> <span class="st">&quot;main_result&quot;</span>,</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;artifacts://results&quot;</span>,</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>  <span class="at">template =</span> <span class="st">&quot;{.stage}/{subject}/outputs&quot;</span>,</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>  <span class="at">write =</span> <span class="sc">~</span> {</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>    work_dir <span class="ot">&lt;-</span> .base</span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>    <span class="fu">dir.create</span>(work_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>    </span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>    <span class="co"># Pipeline writes many files</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>    <span class="fu">run_full_analysis</span>(.x, work_dir)</span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>    <span class="co"># Creates: preprocessed.nii, mask.nii, stats.txt, report.pdf, etc.</span></span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>    </span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>    <span class="co"># But we only track the main result</span></span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a>    main_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(work_dir, <span class="st">&quot;final_statistics.nii.gz&quot;</span>)</span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(main_file)) {</span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;Pipeline failed to create main output&quot;</span>)</span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a>    }</span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a>    main_file</span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a>  },</span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a>  <span class="at">read =</span> <span class="sc">~</span> neuroim2<span class="sc">::</span><span class="fu">read_vol</span>(.path),</span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a>  <span class="at">ext =</span> <span class="st">&quot;.nii.gz&quot;</span></span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="choosing-the-right-pattern" class="section level3">
<h3>Choosing the Right Pattern</h3>
<table>
<colgroup>
<col width="35%" />
<col width="46%" />
<col width="17%" />
</colgroup>
<thead>
<tr class="header">
<th>Use Case</th>
<th>Best Pattern</th>
<th>Why</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Need to know success/failure + location</td>
<td><strong>A: Sentinel</strong></td>
<td>Minimal metadata, easy resume, clean</td>
</tr>
<tr class="even">
<td>Downstream needs to explore outputs</td>
<td><strong>B: Bundle</strong></td>
<td>Directory handle for flexible access</td>
</tr>
<tr class="odd">
<td>Clear primary output file</td>
<td><strong>C: Primary</strong></td>
<td>Track only what matters</td>
</tr>
<tr class="even">
<td>Hundreds of small files</td>
<td><strong>A: Sentinel</strong></td>
<td>Avoid manifest bloat</td>
</tr>
<tr class="odd">
<td>QC and validation needed</td>
<td><strong>A: Sentinel</strong></td>
<td>Embed metrics in done file</td>
</tr>
<tr class="even">
<td>Archive/backup scenario</td>
<td><strong>B: Bundle</strong></td>
<td>Preserve directory structure</td>
</tr>
</tbody>
</table>
</div>
<div id="real-world-example-fmri-preprocessing" class="section level3">
<h3>Real-World Example: fMRI Preprocessing</h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="co"># Complete fMRI preprocessing with sentinel pattern</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="fu">library</span>(parade)</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="fu">paths_init</span>()</span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>fmri_sink <span class="ot">&lt;-</span> <span class="fu">sink_quick</span>(</span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a>  <span class="at">fields =</span> <span class="st">&quot;preprocessing&quot;</span>,</span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;artifacts://fmri&quot;</span>,</span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a>  <span class="at">template =</span> <span class="st">&quot;{.stage}/{subject}/ses-{session}/run-{run}&quot;</span>,</span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a>  <span class="at">write =</span> <span class="sc">~</span> {</span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a>    out_dir <span class="ot">&lt;-</span> .base</span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a>    <span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a>    </span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a>    <span class="co"># Run fMRIPrep or similar</span></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a>    cmd <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(</span>
<span id="cb27-15"><a href="#cb27-15" tabindex="-1"></a>      <span class="st">&quot;fmriprep %s %s participant --participant-label %s&quot;</span>,</span>
<span id="cb27-16"><a href="#cb27-16" tabindex="-1"></a>      .x<span class="sc">$</span>bids_dir, out_dir, .x<span class="sc">$</span>subject</span>
<span id="cb27-17"><a href="#cb27-17" tabindex="-1"></a>    )</span>
<span id="cb27-18"><a href="#cb27-18" tabindex="-1"></a>    <span class="fu">system</span>(cmd)</span>
<span id="cb27-19"><a href="#cb27-19" tabindex="-1"></a>    </span>
<span id="cb27-20"><a href="#cb27-20" tabindex="-1"></a>    <span class="co"># Write comprehensive done file</span></span>
<span id="cb27-21"><a href="#cb27-21" tabindex="-1"></a>    done <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb27-22"><a href="#cb27-22" tabindex="-1"></a>      <span class="at">ok =</span> <span class="fu">file.exists</span>(<span class="fu">file.path</span>(out_dir, <span class="st">&quot;sub-01_space-MNI152_desc-preproc_bold.nii.gz&quot;</span>)),</span>
<span id="cb27-23"><a href="#cb27-23" tabindex="-1"></a>      <span class="at">completed =</span> <span class="fu">Sys.time</span>(),</span>
<span id="cb27-24"><a href="#cb27-24" tabindex="-1"></a>      <span class="at">subject =</span> .x<span class="sc">$</span>subject,</span>
<span id="cb27-25"><a href="#cb27-25" tabindex="-1"></a>      <span class="at">session =</span> .x<span class="sc">$</span>session,</span>
<span id="cb27-26"><a href="#cb27-26" tabindex="-1"></a>      <span class="at">outputs =</span> <span class="fu">list</span>(</span>
<span id="cb27-27"><a href="#cb27-27" tabindex="-1"></a>        <span class="at">func =</span> <span class="fu">Sys.glob</span>(<span class="fu">file.path</span>(out_dir, <span class="st">&quot;*bold*.nii.gz&quot;</span>)),</span>
<span id="cb27-28"><a href="#cb27-28" tabindex="-1"></a>        <span class="at">anat =</span> <span class="fu">Sys.glob</span>(<span class="fu">file.path</span>(out_dir, <span class="st">&quot;*T1w*.nii.gz&quot;</span>)),</span>
<span id="cb27-29"><a href="#cb27-29" tabindex="-1"></a>        <span class="at">confounds =</span> <span class="fu">Sys.glob</span>(<span class="fu">file.path</span>(out_dir, <span class="st">&quot;*confounds*.tsv&quot;</span>)),</span>
<span id="cb27-30"><a href="#cb27-30" tabindex="-1"></a>        <span class="at">reports =</span> <span class="fu">Sys.glob</span>(<span class="fu">file.path</span>(out_dir, <span class="st">&quot;*.html&quot;</span>))</span>
<span id="cb27-31"><a href="#cb27-31" tabindex="-1"></a>      ),</span>
<span id="cb27-32"><a href="#cb27-32" tabindex="-1"></a>      <span class="at">qc =</span> <span class="fu">list</span>(</span>
<span id="cb27-33"><a href="#cb27-33" tabindex="-1"></a>        <span class="at">motion =</span> <span class="fu">read.table</span>(<span class="fu">file.path</span>(out_dir, <span class="st">&quot;motion_parameters.txt&quot;</span>)),</span>
<span id="cb27-34"><a href="#cb27-34" tabindex="-1"></a>        <span class="at">tsnr =</span> <span class="fu">mean</span>(<span class="fu">read_tsnr</span>(out_dir))</span>
<span id="cb27-35"><a href="#cb27-35" tabindex="-1"></a>      )</span>
<span id="cb27-36"><a href="#cb27-36" tabindex="-1"></a>    )</span>
<span id="cb27-37"><a href="#cb27-37" tabindex="-1"></a>    </span>
<span id="cb27-38"><a href="#cb27-38" tabindex="-1"></a>    jsonlite<span class="sc">::</span><span class="fu">write_json</span>(done, .path, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-39"><a href="#cb27-39" tabindex="-1"></a>    .path</span>
<span id="cb27-40"><a href="#cb27-40" tabindex="-1"></a>  },</span>
<span id="cb27-41"><a href="#cb27-41" tabindex="-1"></a>  <span class="at">ext =</span> <span class="st">&quot;.prep.json&quot;</span>,</span>
<span id="cb27-42"><a href="#cb27-42" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="st">&quot;skip&quot;</span>  <span class="co"># Don&#39;t rerun completed subjects</span></span>
<span id="cb27-43"><a href="#cb27-43" tabindex="-1"></a>)</span>
<span id="cb27-44"><a href="#cb27-44" tabindex="-1"></a></span>
<span id="cb27-45"><a href="#cb27-45" tabindex="-1"></a><span class="co"># Run preprocessing pipeline</span></span>
<span id="cb27-46"><a href="#cb27-46" tabindex="-1"></a>subjects_grid <span class="ot">&lt;-</span> <span class="fu">param_grid</span>(</span>
<span id="cb27-47"><a href="#cb27-47" tabindex="-1"></a>  <span class="at">subject =</span> <span class="fu">sprintf</span>(<span class="st">&quot;sub-%02d&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>),</span>
<span id="cb27-48"><a href="#cb27-48" tabindex="-1"></a>  <span class="at">session =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,</span>
<span id="cb27-49"><a href="#cb27-49" tabindex="-1"></a>  <span class="at">run =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,</span>
<span id="cb27-50"><a href="#cb27-50" tabindex="-1"></a>  <span class="at">bids_dir =</span> <span class="st">&quot;/data/myStudy&quot;</span></span>
<span id="cb27-51"><a href="#cb27-51" tabindex="-1"></a>)</span>
<span id="cb27-52"><a href="#cb27-52" tabindex="-1"></a></span>
<span id="cb27-53"><a href="#cb27-53" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">flow</span>(subjects_grid) <span class="sc">|&gt;</span></span>
<span id="cb27-54"><a href="#cb27-54" tabindex="-1"></a>  <span class="fu">stage</span>(<span class="st">&quot;fmriprep&quot;</span>,</span>
<span id="cb27-55"><a href="#cb27-55" tabindex="-1"></a>    <span class="at">f =</span> <span class="cf">function</span>(subject, session, run, bids_dir) {</span>
<span id="cb27-56"><a href="#cb27-56" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">preprocessing =</span> <span class="fu">list</span>(</span>
<span id="cb27-57"><a href="#cb27-57" tabindex="-1"></a>        <span class="at">subject =</span> subject,</span>
<span id="cb27-58"><a href="#cb27-58" tabindex="-1"></a>        <span class="at">session =</span> session,</span>
<span id="cb27-59"><a href="#cb27-59" tabindex="-1"></a>        <span class="at">run =</span> run,</span>
<span id="cb27-60"><a href="#cb27-60" tabindex="-1"></a>        <span class="at">bids_dir =</span> bids_dir</span>
<span id="cb27-61"><a href="#cb27-61" tabindex="-1"></a>      ))</span>
<span id="cb27-62"><a href="#cb27-62" tabindex="-1"></a>    },</span>
<span id="cb27-63"><a href="#cb27-63" tabindex="-1"></a>    <span class="at">schema =</span> <span class="fu">returns</span>(<span class="at">preprocessing =</span> <span class="fu">artifact</span>()),</span>
<span id="cb27-64"><a href="#cb27-64" tabindex="-1"></a>    <span class="at">sink =</span> fmri_sink</span>
<span id="cb27-65"><a href="#cb27-65" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb27-66"><a href="#cb27-66" tabindex="-1"></a>  <span class="fu">distribute</span>(<span class="fu">dist_slurm</span>(<span class="at">n =</span> <span class="dv">20</span>))  <span class="co"># Parallel on cluster</span></span>
<span id="cb27-67"><a href="#cb27-67" tabindex="-1"></a></span>
<span id="cb27-68"><a href="#cb27-68" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">collect</span>(fl)</span>
<span id="cb27-69"><a href="#cb27-69" tabindex="-1"></a></span>
<span id="cb27-70"><a href="#cb27-70" tabindex="-1"></a><span class="co"># Check success and get file lists</span></span>
<span id="cb27-71"><a href="#cb27-71" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(results)) {</span>
<span id="cb27-72"><a href="#cb27-72" tabindex="-1"></a>  done <span class="ot">&lt;-</span> jsonlite<span class="sc">::</span><span class="fu">read_json</span>(results<span class="sc">$</span>preprocessing[[i]]<span class="sc">$</span>path)</span>
<span id="cb27-73"><a href="#cb27-73" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>done<span class="sc">$</span>ok) {</span>
<span id="cb27-74"><a href="#cb27-74" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Failed: %s&quot;</span>, done<span class="sc">$</span>subject))</span>
<span id="cb27-75"><a href="#cb27-75" tabindex="-1"></a>  }</span>
<span id="cb27-76"><a href="#cb27-76" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="tips-for-multi-file-patterns" class="section level3">
<h3>Tips for Multi-File Patterns</h3>
<ol style="list-style-type: decimal">
<li><strong>Always use <code>overwrite = &quot;skip&quot;</code></strong> for
resume-friendly workflows</li>
<li><strong>Include validation</strong> in your sentinel (checksums,
file counts, QC metrics)</li>
<li><strong>Use <code>.base</code> in formulas</strong> to get directory
paths without extensions</li>
<li><strong>Create row-specific directories</strong> via template to
avoid file collisions</li>
<li><strong>Document outputs</strong> in the sentinel for downstream
discovery</li>
<li><strong>Consider manifest()</strong> later to explore the full file
tree if needed</li>
</ol>
</div>
</div>
<div id="tips-and-best-practices" class="section level2">
<h2>Tips and best practices</h2>
<ol style="list-style-type: decimal">
<li><p><strong>Start simple</strong>: Use <code>sink_quick()</code>
during development, refine with <code>sink_spec()</code> for
production</p></li>
<li><p><strong>Choose formats wisely</strong>:</p>
<ul>
<li>RDS/QS for R-only workflows</li>
<li>Parquet for data frames and cross-language needs</li>
<li>JSON for configuration and metadata</li>
</ul></li>
<li><p><strong>Mix formats</strong>: Use <code>formats</code> parameter
to optimize each field independently</p></li>
<li><p><strong>Test with sink_temp()</strong>: Validate workflows
without cluttering your filesystem</p></li>
<li><p><strong>Register once, use everywhere</strong>: Add custom
formats to <code>.Rprofile</code> or package startup</p></li>
<li><p><strong>Monitor with manifest()</strong>: Track artifact growth
and clean up old files systematically</p></li>
</ol>
</div>
<div id="summary" class="section level2">
<h2>Summary</h2>
<p>The format-agnostic sink system in parade 0.12.0+ provides:</p>
<ul>
<li><strong>sink_quick()</strong> - One-liner sink creation</li>
<li><strong>sink_temp()</strong> - Ephemeral sinks for testing</li>
<li><strong>Format registry</strong> - Extensible format support</li>
<li><strong>Per-field formats</strong> - Optimize each artifact
independently</li>
<li><strong>Formula syntax</strong> - Inline custom writers with minimal
code</li>
<li><strong>Built-in formats</strong> - RDS, CSV, JSON, Parquet, and
more</li>
</ul>
<p>Whether you need quick prototyping or production-grade artifact
management, parade‚Äôs sink system scales from simple one-liners to
complex multi-format pipelines while maintaining atomic writes, metadata
tracking, and memory efficiency.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
